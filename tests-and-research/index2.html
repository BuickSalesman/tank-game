<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Matter.js Power Meter</title>
    <style>
      #powerMeter {
        position: absolute;
        bottom: 10px;
        left: 10px;
        height: 20px;
        width: 200px;
        background-color: #ddd;
      }
      #powerLevel {
        height: 100%;
        background-color: #f00;
        width: 0%; /* Start at 0% */
      }
    </style>
  </head>
  <body>
    <div id="powerMeter">
      <div id="powerLevel"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.17.1/matter.min.js"></script>

    <script>
      const { Engine, Render, Runner, Bodies, World, Body, Mouse, MouseConstraint, Events } = Matter;

      // Setup Matter.js engine
      const engine = Engine.create();
      const world = engine.world;

      const render = Render.create({
        element: document.body,
        engine: engine,
        options: {
          width: 800,
          height: 600,
          wireframes: false,
          background: "#fafafa",
        },
      });

      // Create the tank (rectangle) and ground (static)
      const tank = Bodies.rectangle(400, 300, 50, 50, { restitution: 2 });
      const ground = Bodies.rectangle(400, 580, 810, 60, { restitution: 1, isStatic: true });

      World.add(world, [tank, ground]);

      // Power meter elements
      const powerLevelElement = document.getElementById("powerLevel");
      let powerLevel = 0;
      let maxPowerLevel = 100;
      let isMouseDown = false;

      // Mouse control for Matter.js
      const mouse = Mouse.create(render.canvas);
      const mouseConstraint = MouseConstraint.create(engine, {
        mouse: mouse,
        constraint: {
          stiffness: 0,
          render: {
            visible: false,
          },
        },
      });

      World.add(world, mouseConstraint);

      Render.run(render);
      const runner = Runner.create();
      Runner.run(runner, engine);

      // Start tracking power when mouse is down
      Events.on(mouseConstraint, "mousedown", () => {
        isMouseDown = true;
      });

      // Apply force and reset power level when mouse is up
      Events.on(mouseConstraint, "mouseup", () => {
        if (powerLevel > 0) {
          const forceMagnitude = powerLevel * 0.0005; // Scale the force
          Body.applyForce(tank, tank.position, { x: 0, y: -forceMagnitude * 10 });
        }
        resetPower();
      });

      // Update power meter during each engine tick
      Events.on(engine, "beforeUpdate", () => {
        if (isMouseDown) {
          increasePower();
        }
      });

      function increasePower() {
        if (powerLevel < maxPowerLevel) {
          powerLevel += 10; // Increase power level
          powerLevelElement.style.width = `${powerLevel}%`; // Update visual meter
        }
      }

      function resetPower() {
        powerLevel = 0;
        powerLevelElement.style.width = "0%"; // Reset visual meter
        isMouseDown = false;
      }
    </script>
  </body>
</html>
